name: Publish PDF to GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - '**.tex'
      - '.github/workflows/pages.yml'
  workflow_dispatch:  # permite ejecutar manualmente desde Actions

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build stamp (commit y fecha)
        run: |
          echo "\\def\\BuildSHA{${GITHUB_SHA}}" > build.tex
          echo "\\def\\BuildDate{`date -u +%Y-%m-%dT%H:%M:%SZ`}" >> build.tex

      - name: Build PDFs (libro + cap√≠tulos + res√∫menes + slides)
        uses: xu-cheng/latex-action@v3
        with:
          root_file: |
            main.tex
            cap1_only.tex
            cap2_only.tex
            cap3_only.tex
            cap1_resumen.tex
            cap2_resumen.tex
            cap3_resumen.tex
            slides/cap1_slides.tex
            slides/cap2_slides.tex
            slides/cap3_slides.tex
          args: -pdf -interaction=nonstopmode -file-line-error
          work_in_root_file_dir: false

      # --- Depuraci√≥n opcional: verifica que los PDFs existan
      - name: Debug workspace
        run: |
          echo "Listando archivos en el workspace:"
          ls -la
          for f in \
            main.pdf cap1_only.pdf cap2_only.pdf cap3_only.pdf \
            cap1_resumen.pdf cap2_resumen.pdf cap3_resumen.pdf \
            slides/cap1_slides.pdf slides/cap2_slides.pdf slides/cap3_slides.pdf
          do
            test -f "$f" && echo "OK: $f encontrado" || (echo "ERROR: $f NO existe" && exit 1)
          done

      - name: Prepare site (public/)
        run: |
          mkdir -p public
          # Renombrar PDFs con nombres amigables
          cp main.pdf                  public/LibroControl.pdf
          cp cap1_only.pdf             public/Capitulo1.pdf
          cp cap2_only.pdf             public/Capitulo2.pdf
          cp cap3_only.pdf             public/Capitulo3.pdf
          cp cap1_resumen.pdf          public/Resumen_Cap1.pdf
          cp cap2_resumen.pdf          public/Resumen_Cap2.pdf
          cp cap3_resumen.pdf          public/Resumen_Cap3.pdf
          cp slides/cap1_slides.pdf    public/Slides_Cap1.pdf
          cp slides/cap2_slides.pdf    public/Slides_Cap2.pdf
          cp slides/cap3_slides.pdf    public/Slides_Cap3.pdf

          # Slides: OJO, sin 'slides/' delante
          cp cap1_slides.pdf   public/Slides_Cap1.pdf
          cp cap2_slides.pdf   public/Slides_Cap2.pdf
          cp cap3_slides.pdf   public/Slides_Cap3.pdf

          cat > public/index.html << 'EOF'
          <!doctype html>
          <meta charset="utf-8">
          <title>LibroControl ‚Äì Publicaciones</title>
          <style>
            body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;margin:24px;line-height:1.5}
            .wrap{max-width:1100px;margin:auto}
            .row{display:flex;gap:16px;flex-wrap:wrap}
            .card{flex:1 1 320px;border:1px solid #ddd;border-radius:12px;padding:16px}
            iframe{width:100%;height:60vh;border:1px solid #ddd;border-radius:10px}
            a.button{display:inline-block;margin:8px 0;padding:8px 14px;border:1px solid #444;border-radius:10px;text-decoration:none}
            h2{margin:0 0 8px}
            .muted{color:#666;font-size:.95rem;margin:0 0 16px}
          </style>
          <div class="wrap">
            <h1>LibroControl ‚Äì Publicaciones</h1>
            <p class="muted">Versi√≥n publicada por GitHub Actions (compilaci√≥n autom√°tica desde LaTeX).</p>

            <h2>üìñ Libro completo</h2>
            <div class="row">
              <div class="card">
                <h2>Libro completo</h2>
                <a class="button" href="LibroControl.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="LibroControl.pdf" title="Libro completo"></iframe>
              </div>
            </div>

            <h2 style="margin-top:28px">üìö Cap√≠tulos individuales</h2>
            <div class="row">
              <div class="card">
                <h2>Cap√≠tulo 1</h2>
                <a class="button" href="Capitulo1.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Capitulo1.pdf" title="Cap√≠tulo 1"></iframe>
              </div>
              <div class="card">
                <h2>Cap√≠tulo 2</h2>
                <a class="button" href="Capitulo2.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Capitulo2.pdf" title="Cap√≠tulo 2"></iframe>
              </div>
              <div class="card">
                <h2>Cap√≠tulo 3</h2>
                <a class="button" href="Capitulo3.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Capitulo3.pdf" title="Cap√≠tulo 3"></iframe>
              </div>
            </div>

            <h2 style="margin-top:28px">üìë Res√∫menes por cap√≠tulo</h2>
            <div class="row">
              <div class="card">
                <h2>Resumen Cap√≠tulo 1</h2>
                <a class="button" href="Resumen_Cap1.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Resumen_Cap1.pdf" title="Resumen Cap√≠tulo 1"></iframe>
              </div>
              <div class="card">
                <h2>Resumen Cap√≠tulo 2</h2>
                <a class="button" href="Resumen_Cap2.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Resumen_Cap2.pdf" title="Resumen Cap√≠tulo 2"></iframe>
              </div>
              <div class="card">
                <h2>Resumen Cap√≠tulo 3</h2>
                <a class="button" href="Resumen_Cap3.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Resumen_Cap3.pdf" title="Resumen Cap√≠tulo 3"></iframe>
              </div>
            </div>

            <h2 style="margin-top:28px">üñ•Ô∏è Slides por cap√≠tulo</h2>
            <div class="row">
              <div class="card">
                <h2>Slides Cap√≠tulo 1</h2>
                <a class="button" href="Slides_Cap1.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Slides_Cap1.pdf" title="Slides Cap√≠tulo 1"></iframe>
              </div>
              <div class="card">
                <h2>Slides Cap√≠tulo 2</h2>
                <a class="button" href="Slides_Cap2.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Slides_Cap2.pdf" title="Slides Cap√≠tulo 2"></iframe>
              </div>
              <div class="card">
                <h2>Slides Cap√≠tulo 3</h2>
                <a class="button" href="Slides_Cap3.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Slides_Cap3.pdf" title="Slides Cap√≠tulo 3"></iframe>
              </div>
            </div>
          </div>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        id: deployment
