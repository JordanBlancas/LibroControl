name: Publish PDF to GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - '**.tex'
      - '.github/workflows/pages.yml'
  workflow_dispatch:  # permite ejecutar manualmente desde Actions

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build stamp (commit y fecha)
        run: |
          echo "\\def\\BuildSHA{${GITHUB_SHA}}" > build.tex
          echo "\\def\\BuildDate{`date -u +%Y-%m-%dT%H:%M:%SZ`}" >> build.tex

      - name: Build PDFs (libro + cap√≠tulos + res√∫menes + slides)
        uses: xu-cheng/latex-action@v3
        with:
          root_file: |
            main.tex
            cap1_only.tex
            cap2_only.tex
            cap3_only.tex
            cap1_resumen.tex
            cap2_resumen.tex
            cap3_resumen.tex
            slides/cap1_slides.tex
            slides/cap2_slides.tex
            slides/cap3_slides.tex
          args: -pdf -interaction=nonstopmode -file-line-error
          work_in_root_file_dir: false

      - name: Debug PDFs
        run: |
          echo "PWD = $(pwd)"
          echo "Listado de PDFs (profundidad 2):"
          find . -maxdepth 2 -type f -name "*.pdf" -print | sort

      - name: Debug workspace (no-fatal)
        run: |
          echo "√Årbol de trabajo (nivel 2):"
          find . -maxdepth 2 -type f -print | sort || true

      - name: Prepare site (public/)
        run: |
          set -e
          mkdir -p public

          copy_first_exist () {
            # $1 = nombre base (sin ruta), $2 = destino en public
            for src in "./$1" "./slides/$1"; do
              if [ -f "$src" ]; then
                cp -f "$src" "public/$2"
                echo "OK: copiado $src -> public/$2"
                return 0
              fi
            done
            echo "ERROR: no se encontr√≥ $1 ni en . ni en ./slides/"
            exit 1
          }

          # Libro/cap√≠tulos/res√∫menes
          copy_first_exist "main.pdf"         "LibroControl.pdf"
          copy_first_exist "cap1_only.pdf"    "Capitulo1.pdf"
          copy_first_exist "cap2_only.pdf"    "Capitulo2.pdf"
          copy_first_exist "cap3_only.pdf"    "Capitulo3.pdf"
          copy_first_exist "cap1_resumen.pdf" "Resumen_Cap1.pdf"
          copy_first_exist "cap2_resumen.pdf" "Resumen_Cap2.pdf"
          copy_first_exist "cap3_resumen.pdf" "Resumen_Cap3.pdf"

          # Slides (funciona est√©n en . o en slides/)
          copy_first_exist "cap1_slides.pdf"  "Slides_Cap1.pdf"
          copy_first_exist "cap2_slides.pdf"  "Slides_Cap2.pdf"
          copy_first_exist "cap3_slides.pdf"  "Slides_Cap3.pdf"

          # P√°gina
          cat > public/index.html << 'EOF'
          <!doctype html>
          <meta charset="utf-8">
          <title>LibroControl ‚Äì Publicaciones</title>
          <style>
            body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;margin:24px;line-height:1.5}
            .wrap{max-width:1100px;margin:auto}
            .row{display:flex;gap:16px;flex-wrap:wrap}
            .card{flex:1 1 320px;border:1px solid #ddd;border-radius:12px;padding:16px}
            iframe{width:100%;height:60vh;border:1px solid #ddd;border-radius:10px}
            a.button{display:inline-block;margin:8px 0;padding:8px 14px;border:1px solid #444;border-radius:10px;text-decoration:none}
            h2{margin:0 0 8px}
            .muted{color:#666;font-size:.95rem;margin:0 0 16px}
          </style>
          <div class="wrap">
            <h1>LibroControl ‚Äì Publicaciones</h1>
            <p class="muted">Versi√≥n publicada por GitHub Actions (compilaci√≥n autom√°tica desde LaTeX).</p>

            <h2>üìñ Libro completo</h2>
            <div class="row">
              <div class="card">
                <h2>Libro completo</h2>
                <a class="button" href="LibroControl.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="LibroControl.pdf" title="Libro completo"></iframe>
              </div>
            </div>

            <h2 style="margin-top:28px">üìö Cap√≠tulos individuales</h2>
            <div class="row">
              <div class="card">
                <h2>Cap√≠tulo 1</h2>
                <a class="button" href="Capitulo1.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Capitulo1.pdf" title="Cap√≠tulo 1"></iframe>
              </div>
              <div class="card">
                <h2>Cap√≠tulo 2</h2>
                <a class="button" href="Capitulo2.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Capitulo2.pdf" title="Cap√≠tulo 2"></iframe>
              </div>
              <div class="card">
                <h2>Cap√≠tulo 3</h2>
                <a class="button" href="Capitulo3.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Capitulo3.pdf" title="Cap√≠tulo 3"></iframe>
              </div>
            </div>

            <h2 style="margin-top:28px">üìë Res√∫menes por cap√≠tulo</h2>
            <div class="row">
              <div class="card">
                <h2>Resumen Cap√≠tulo 1</h2>
                <a class="button" href="Resumen_Cap1.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Resumen_Cap1.pdf" title="Resumen Cap√≠tulo 1"></iframe>
              </div>
              <div class="card">
                <h2>Resumen Cap√≠tulo 2</h2>
                <a class="button" href="Resumen_Cap2.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Resumen_Cap2.pdf" title="Resumen Cap√≠tulo 2"></iframe>
              </div>
              <div class="card">
                <h2>Resumen Cap√≠tulo 3</h2>
                <a class="button" href="Resumen_Cap3.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Resumen_Cap3.pdf" title="Resumen Cap√≠tulo 3"></iframe>
              </div>
            </div>

            <h2 style="margin-top:28px">üñ•Ô∏è Slides por cap√≠tulo</h2>
            <div class="row">
              <div class="card">
                <h2>Slides Cap√≠tulo 1</h2>
                <a class="button" href="Slides_Cap1.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Slides_Cap1.pdf" title="Slides Cap√≠tulo 1"></iframe>
              </div>
              <div class="card">
                <h2>Slides Cap√≠tulo 2</h2>
                <a class="button" href="Slides_Cap2.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Slides_Cap2.pdf" title="Slides Cap√≠tulo 2"></iframe>
              </div>
              <div class="card">
                <h2>Slides Cap√≠tulo 3</h2>
                <a class="button" href="Slides_Cap3.pdf">‚¨áÔ∏è Descargar PDF</a>
                <iframe src="Slides_Cap3.pdf" title="Slides Cap√≠tulo 3"></iframe>
              </div>
            </div>
          </div>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        id: deployment
